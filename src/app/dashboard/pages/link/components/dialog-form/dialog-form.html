<p-dialog
    [header]="selectedLink() ? 'Editar enlace' : 'Crear nuevo enlace'"
    class="!overflow-hidden"
    [visible]="display()"
    (visibleChange)="onCloseDialog.emit()"
    [breakpoints]="{ '1199px': '75vw', '575px': '90vw' }"
    [style]="{ width: '25rem' }"
    [modal]="true"
    [closable]="!linkService.loading()"
>
    <form id="link-form" class="flex flex-col gap-4" [formGroup]="form" (ngSubmit)="saveChanges()">
        @let type = form.controls['type'].value;

        <div class="flex flex-col gap-2">
            <label for="link-type">Crear nuevo</label>
            <p-select id="link-type" formControlName="type" [options]="linkTypes" optionLabel="label" optionValue="value" placeholder="Selecciona el tipo de enlace"></p-select>
        </div>

        <div class="flex flex-col gap-2">
            @if (type === LinkType.EXTERNAL) {
            <label for="url">URL</label>
            <input id="url" type="text" pInputText formControlName="url" placeholder="https://example.com" />
            @if (form.controls['url'].errors) {
            <p-message severity="error" size="small" variant="simple"> {{ FormUtils.getFieldError(form, 'url') }} </p-message>
            } } @else if (type === LinkType.PAGE) {

            <label for="page">Página</label>

            <app-error-boundary skeletonHeight="2.5rem" [resource]="pagesList" errorMessage="Ocurrió un error cargando las páginas.">
                <ng-template #content let-pages>
                    <p-select
                        [overlayOptions]="{
                    mode: 'modal'
                    }"
                        class="w-full"
                        id="page"
                        formControlName="pageId"
                        [options]="pages"
                        [checkmark]="true"
                        [filter]="true"
                        filterBy="title,slug"
                        optionLabel="title"
                        optionValue="id"
                        placeholder="Selecciona una página"
                    >
                        <ng-template #selectedItem let-selectedPage>
                            @if (selectedPage) {
                            <div class="flex flex-col justify-center">
                                {{ selectedPage.title }}
                                <small>(/{{ selectedPage.slug }})</small>
                            </div>
                            }
                        </ng-template>
                        <ng-template let-page #item>
                            <div class="flex flex-col justify-center">
                                {{ page.title }}
                                <small>(/{{ page.slug }})</small>
                            </div>
                        </ng-template>
                    </p-select>
                    @if (form.controls['pageId'].errors) {
                    <p-message severity="error" size="small" variant="simple"> {{ FormUtils.getFieldError(form, 'pageId') }} </p-message>
                    }
                </ng-template>
            </app-error-boundary>
            } @else if (type === LinkType.FILE) {
            <label for="file">Archivo</label>
            <p-fileUpload
                id="file"
                name="file"
                invalidFileSizeMessageSummary="Archivo demasiado grande"
                invalidFileSizeMessageDetail="El tamaño máximo permitido es de 5MB."
                invalidFileTypeMessageSummary="Tipo de archivo inválido"
                invalidFileTypeMessageDetail="Solo se permiten archivos PDF."
                invalidFileLimitMessageSummary="Límite de archivos excedido"
                invalidFileLimitMessageDetail="Has excedido el número máximo de archivos permitidos."
                chooseLabel="Seleccionar archivo"
                [showUploadButton]="false"
                (onSelect)="onFileSelect($event)"
                [showCancelButton]="false"
                [multiple]="false"
                accept=".pdf"
                maxFileSize="5000000"
                mode="advanced"
            >
                <ng-template #empty>
                    @let currentFileUrl = form.controls['currentFileUrl'].value; @if (currentFileUrl) {
                    <div class="flex flex-col items-center justify-center py-8 text-surface-500">
                        <i class="pi pi-file text-4xl mb-3"></i>
                        <div class="font-semibold text-lg mb-1">Archivo cargado</div>
                        <div class="text-sm mb-4">Ya hay un archivo asociado a este enlace.</div>
                        <a href="{{ currentFileUrl }}" target="_blank" class="p-button p-component p-button-outlined">
                            <span class="p-button-icon pi pi-cloud-download"></span>
                            <span class="p-button-label">Descargar archivo</span>
                        </a>
                    </div>
                    } @else {
                    <div class="flex items-center justify-center w-full">
                        <label
                            for="dropzone-file"
                            class="flex flex-col items-center justify-center w-full h-48 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 dark:hover:bg-gray-800 dark:bg-gray-700 hover:bg-gray-100 dark:border-gray-600 dark:hover:border-gray-500"
                        >
                            <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                <svg class="w-8 h-8 mb-4 text-gray-500 dark:text-gray-400" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16">
                                    <path
                                        stroke="currentColor"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"
                                    />
                                </svg>
                                <p class="mb-2 text-sm text-gray-500 dark:text-gray-400"><span class="font-semibold">Arrastrar</span> tu archivo aquí</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">PDF, (MAX. 5MB)</p>
                            </div>
                        </label>
                    </div>
                    }
                </ng-template>
            </p-fileUpload>
            @if (form.controls['file'].errors) {
            <p-message severity="error" size="small" variant="simple"> {{ FormUtils.getFieldError(form, 'file') }} </p-message>

            } }
        </div>

        <div class="flex flex-col gap-2">
            <label for="title">Titulo</label>
            <!-- <p-select id="title" formControlName="type" [options]="linkTypes()" optionLabel="label" optionValue="value" placeholder="Selecciona el tipo de enlace"></p-select> -->
            <input id="title" type="text" pInputText formControlName="title" placeholder="Título del enlace" />
            @if (form.controls['title'].errors) {
            <p-message severity="error" size="small" variant="simple"> {{ FormUtils.getFieldError(form, 'title') }} </p-message>
            }
        </div>

        <!-- @if (type !== LinkType.FILE) { -->
        <div class="flex flex-col gap-2">
            <label for="open-tab">Abrir en</label>
            <p-selectbutton formControlName="openInNewTab" id="open-tab" [options]="linkTargets" optionLabel="label" optionValue="value" aria-labelledby="open-tab"></p-selectbutton>
            @if (form.controls['openInNewTab'].errors) {
            <p-message severity="error" size="small" variant="simple"> {{ FormUtils.getFieldError(form, 'openInNewTab') }} </p-message>
            }
        </div>

        <!-- } -->
    </form>

    <!-- {{ form.value | json }} -->

    <ng-template #footer>
        <button pButton [loading]="linkService.loading()" icon="pi pi-save" type="submit" form="link-form" [disabled]="form.invalid" label="Guardar"></button>
    </ng-template>
</p-dialog>
