@if (selectedPage()) {
<app-error-boundary [resource]="sectionList" [errorMessage]="'No se pudieron cargar las secciones.'" [emptyMessage]="'No hay secciones disponibles.'">
    <ng-template #loading>
        <app-data-view-skeleton></app-data-view-skeleton>
    </ng-template>

    <ng-template #content let-sections>
        @let filteredSections = sections | filterSectionsByPage:selectedPage()!.id;

        <div class="mt-4 flex flex-col gap-4">
            @if (filteredSections.length === 0) {
            <div class="flex flex-col items-center justify-center py-8 text-surface-500">
                <i class="pi pi-inbox text-4xl mb-3"></i>
                <div class="font-semibold text-lg mb-1">No se encontraron secciones</div>
                <div class="text-sm">Intenta ajustar tu búsqueda o crea una nueva sección para comenzar.</div>
            </div>

            } @else {
            <div cdkDropList [cdkDropListData]="filteredSections" (cdkDropListDropped)="drop($event, filteredSections)" class="flex flex-col gap-4">
                @if (hasPositionChanged()) {
                <p-message (onClose)="cancelChanges()" severity="info" class="mb-4 w-full" [closable]="true">
                    <ng-template #icon>
                        <p-button (click)="savePositionChanges()" label="Guardar cambios" text class="ml-2" icon="pi pi-save" severity="info"></p-button>
                    </ng-template>
                    <div class="flex items-center justify-between">
                        <span class="ml-2">Has cambiado el orden de las secciones</span>
                        <div></div>
                    </div>
                </p-message>
                } @for (section of filteredSections; track section.id) { 
                    @let status = sectionStatusOptions[`${section.active}`]; 
                    @let typeOption = sectionTypesOptions[section.type];
                <div class="bg-white dark:bg-surface-800 rounded-lg border border-surface-200 dark:border-surface-700 p-5" cdkDrag>
                    <div class="flex items-center justify-between mb-5 flex-wrap gap-3">
                        <div class="flex items-center gap-3">
                            <!-- Drag handle -->
                            <i class="pi pi-bars text-surface-600 dark:text-surface-400 cursor-move" aria-label="Drag Handle" cdkDragHandle></i>
                            <div class="flex flex-col">
                                <h6 class="!text-xl !m-0 max-w-3xl">{{ section.title }}</h6>
                                <div class="flex items-center gap-2 flex-wrap">
                                    <p-badge value="{{ typeOption.label }}" [severity]="typeOption.severity" class="text-sm mb-1 w-fit"></p-badge>
                                    <span class="text-muted-color text-sm">{{ section.items.length }} item{{ section.items.length === 1 ? '' : 's' }} • </span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 flex-wrap ml-auto">
                            <p-tag [severity]="status.severity" class="text-sm" [value]="status.label"></p-tag>
                            @if (![SectionType.MAIN_NAVIGATION_MENU, SectionType.CTA_BANNER].includes(section.type)) {
                            <p-button icon="pi pi-plus" label="Agregar item" (click)="openDialogItem(section)"></p-button>
                            }
                            <p-button icon="pi pi-pencil" text (click)="openDialogAndEdit(section)"></p-button>
                            <p-button icon="pi pi-trash" text severity="danger" (click)="deleteSection($event, section)"></p-button>
                        </div>
                    </div>

                    <!-- @if (section.items.length > 0) { -->

                    <p-panel class="dark:!bg-surface-800 dark:!border-surface-700" [toggleable]="true"
                     (contextmenu)="contextMenu.onContextMenu($event, section)"
                   
                    >
                        <ng-template #header>
                            <div class="flex items-center gap-3">
                                <i class="pi pi-folder-open text-surface-600 dark:text-surface-400"></i>
                                <span>Contenido</span>
                            </div>
                        </ng-template>

                        @switch (section.type) { @case (SectionType.HERO) {
                        <section-hero-items [deleteItemConfirmation]="deleteSectionItemConfirmation.bind(this)" [sectionItems]="section.items" (onSelectSectionItem)="openDialogItem(section, $event)"></section-hero-items>
                        } @case (SectionType.WHY_US) {
                        <section-why-us-items [deleteItemConfirmation]="deleteSectionItemConfirmation.bind(this)" [section]="section" (onSelectSectionItem)="openDialogItem(section, $event)"></section-why-us-items>
                        } @case (SectionType.CASH_PROCESSING_EQUIPMENT) {
                        <section-cash-processing-equipment-items
                            [section]="section"
                            [deleteItemConfirmation]="deleteSectionItemConfirmation.bind(this)"
                            (onSelectSectionItem)="openDialogItem(section, $event)"
                        ></section-cash-processing-equipment-items>
                        } @case (SectionType.VALUE_PROPOSITION) {
                        <section-value-proposition-items [deleteItemConfirmation]="deleteSectionItemConfirmation.bind(this)" [section]="section" (onSelectSectionItem)="openDialogItem(section, $event)"></section-value-proposition-items>
                        } @case (SectionType.CLIENT) {
                        <section-client-items [section]="section" [deleteItemConfirmation]="deleteSectionItemConfirmation.bind(this)" (onSelectSectionItem)="openDialogItem(section, $event)"></section-client-items>
                        } @case (SectionType.OUR_COMPANY) {
                        <section-our-company-items [section]="section" [deleteItemConfirmation]="deleteSectionItemConfirmation.bind(this)" (onSelectSectionItem)="openDialogItem(section, $event)"></section-our-company-items>

                        } @case (SectionType.MACHINE) {
                        <section-machine-items [section]="section" [deleteItemConfirmation]="deleteSectionItemConfirmation.bind(this)" (onSelectSectionItem)="openDialogItem(section, $event)"></section-machine-items>
                        } @case (SectionType.CONTACT_TOP_BAR) {
                        <section-contact-top-bar-items [section]="section" [deleteItemConfirmation]="deleteSectionItemConfirmation.bind(this)" (onSelectSectionItem)="openDialogItem(section, $event)"></section-contact-top-bar-items>
                        } @case (SectionType.MAIN_NAVIGATION_MENU) {
                        <section-main-navigation-menu-items [section]="section"></section-main-navigation-menu-items>
                        } @case (SectionType.CTA_BANNER) {
                        <section-cta-banner-items [section]="section"></section-cta-banner-items>
                        } @case (SectionType.SOLUTIONS_OVERVIEW) {
                        <section-solutions-overview-items [section]="section" [deleteItemConfirmation]="deleteSectionItemConfirmation.bind(this)" (onSelectSectionItem)="openDialogItem(section, $event)"></section-solutions-overview-items>
                        } @case (SectionType.MISSION_VISION) {
                        <section-mission-vision-items [section]="section" [deleteItemConfirmation]="deleteSectionItemConfirmation.bind(this)" (onSelectSectionItem)="openDialogItem(section, $event)"></section-mission-vision-items>
                        } @case (SectionType.CONTACT_US) {
                        <section-contact-us-items [section]="section" [deleteItemConfirmation]="deleteSectionItemConfirmation.bind(this)" (onSelectSectionItem)="openDialogItem(section, $event)"></section-contact-us-items>
                        } @case (SectionType.FOOTER) {
                        <section-footer-items [section]="section" [deleteItemConfirmation]="deleteSectionItemConfirmation.bind(this)" (onSelectSectionItem)="openDialogItem(section, $event)"></section-footer-items>
                        } @default {
                        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-y-4 gap-x-12">
                            @for (item of section.items; track item.id) {
                            <section-item [sectionItem]="item" (onSelectSectionItem)="openDialogItem(section, item)"></section-item>
                            }
                        </div>
                        } }
                    </p-panel>

                    <!-- } -->
                </div>
                }
            </div>
            }
            <context-menu-crud
                [(selectedItem)]="currentSection"
                [editCommand]="edit"
                [deleteCommand]="delete"
            ></context-menu-crud>
        </div>

        <section-item-form [display]="displayItemDialog()" (onCloseDialog)="displayItemDialog.set(false)" [(selectedSectionItem)]="selectedSectionItem" [selectedSection]="currentSection()"></section-item-form>
    </ng-template>
</app-error-boundary>

} @else {
<div class="alert alert-info" style="text-align: center; margin-top: 2rem">
    <h2>Seleccione una página</h2>
    <p>Por favor, elija una página de la lista para ver su contenido.</p>
</div>
}
