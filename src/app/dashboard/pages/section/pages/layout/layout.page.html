<p-confirmdialog />
<div class="flex flex-col max-w-7xl mx-auto">
    <div class="card">
        <div class="sticky top-16 bg-[var(--surface-card)] pb-2 z-20">
            <div class="flex justify-between items-center flex-wrap gap-4 mb-4">
                <div class="flex flex-col gap-0">
                    <h5 class="!text-2xl md:!text-4xl !font-extrabold !m-0">Secciones reutilizables</h5>
                    <span class="text-muted-color md:text-xl">Gestiona las secciones reutilizables y sus items</span>
                </div>

                <div class="flex items-center- flex-wrap gap-2">
                    <p-button label="Nueva Sección" icon="pi pi-plus" (click)="display.set(true)"></p-button>
                </div>
            </div>

            <div class="flex border-b border-surface-200 dark:border-surface-700 pb-4 mb-4 items-center flex-wrap sm:flex-nowrap gap-4">
                <p-inputgroup>
                    <p-inputgroup-addon>
                        <i class="pi pi-search cursor-pointer"></i>
                    </p-inputgroup-addon>
                    <input pInputText placeholder="Buscar sección..." #searchInput />
                </p-inputgroup>

                <p-multiSelect
                    class="sm:max-w-72"
                    [options]="sectionTypesOptions | keyvalue"
                    selectedItemsLabel="{0} tipos seleccionados"
                    emptyFilterMessage="No se encontraron tipos"
                    emptyMessage="No hay tipos disponibles"
                    placeholder="Filtrar por tipo"
                    filterPlaceHolder="Filtrar tipos"
                    optionLabel="value.label"
                    optionValue="key"
                    display="chip"
                    fluid
                    #selectedTypes
                >
                    <ng-template let-type #item>
                        <p-tag [severity]="type.value.severity" class="text-sm" [value]="type.value.label"></p-tag>
                    </ng-template>
                </p-multiSelect>
            </div>
        </div>

        <app-error-boundary [resource]="sectionsLayoutsListRs" [errorMessage]="'No se pudieron cargar las secciones.'" [emptyMessage]="'No hay secciones disponibles.'">
            <ng-template #loading>
                <app-data-view-skeleton></app-data-view-skeleton>
            </ng-template>

            <ng-template #content let-sections>
                @let filteredSections = sections | filterByTerm :'title': searchInput.value | filterArrayBy: 'type': selectedTypes.value;

                <div class="flex flex-col gap-4">
                    @for (section of filteredSections; track section.id) { @let typeOption = getSectionType(section);
                    <div class="bg-white dark:bg-surface-800 rounded-lg border border-surface-200 dark:border-surface-700 p-5" (contextmenu)="contextMenu.onContextMenu($event, section)">
                        <div class="flex items-center justify-between mb-5 flex-wrap gap-3">
                            <div class="flex items-center gap-3">
                                <div class="flex flex-col">
                                    <h6 class="!text-xl !m-0 max-w-3xl">{{ section.title }}</h6>
                                    <div class="flex items-center gap-2 flex-wrap">
                                        <p-badge [value]="typeOption.label" [severity]="typeOption.severity" class="text-sm mb-1 w-fit"></p-badge>
                                        <span class="text-muted-color text-sm">{{ section.items.length }} item{{ section.items.length === 1 ? '' : 's' }} • </span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center gap-2 flex-wrap ml-auto">
                                @if (![SectionType.MAIN_NAVIGATION_MENU, SectionType.CTA_BANNER, SectionType.MACHINE, SectionType.MACHINE_DETAILS, SectionType.MACHINES_CATALOG, SectionType.FOOTER,
                                SectionType.PREVENTIVE_CORRECTIVE_MAINTENANCE].includes(section.type)) {
                                <p-button icon="pi pi-plus" label="Agregar item" (click)="openDialogItem(section)"></p-button>
                                }

                                <!-- @if (associatedPageTemplate) {

                        <ng-container *ngTemplateOutlet="associatedPageTemplate; context: { $implicit: section }"></ng-container>
                        } -->

                                <p-button [loading]="sectionService.loading()" (click)="op.toggle($event); setPages(section)" icon="pi pi-sitemap" label="Asociar páginas" variant="outlined"> </p-button>

                                <p-popover #op>
                                    <div class="flex flex-col gap-4 w-xs" [formGroup]="form">
                                        <app-error-boundary [resource]="pageList" emptyMessage="No hay páginas disponibles para asociar" errorMessage="Hubo un error al cargar las páginas">
                                            <ng-template #content let-pages>
                                                <p-multiSelect
                                                    formControlName="pagesIds"
                                                    size="small"
                                                    [loading]="sectionService.loading()"
                                                    emptyMessage="No hay páginas disponibles para asociar"
                                                    emptyFilterMessage="No se encontraron páginas"
                                                    selectedItemsLabel="{0} páginas seleccionadas"
                                                    [options]="pages"
                                                    optionLabel="title"
                                                    optionValue="id"
                                                    placeholder="Selecciona páginas para asociar"
                                                    filterPlaceHolder="Buscar páginas"
                                                    display="chip"
                                                    fluid
                                                >
                                                    <ng-template #footer>
                                                        <div class="p-3 flex justify-end">
                                                            <p-button
                                                                label="Guardar"
                                                                severity="secondary"
                                                                [disabled]="
                                                form.invalid
                                            "
                                                                text
                                                                size="small"
                                                                icon="pi pi-save"
                                                                (click)="associateToPages(section); op.hide()"
                                                            />
                                                        </div>
                                                    </ng-template>
                                                </p-multiSelect>
                                                @if (form.controls['pagesIds'].errors) {
                                                <p-message severity="error" variant="simple" size="small">{{FormUtils.getFieldError(form, 'pagesIds')}}</p-message>
                                                }
                                            </ng-template>
                                        </app-error-boundary>
                                    </div>
                                </p-popover>
                            </div>
                        </div>

                        <section-items
                            [section]="section"
                            (onSelectSectionItem)="openDialogItem(section, $event)"
                            [deleteItemConfirmation]="deleteSectionItemConfirmation.bind(this)"
                            [duplicateSectionItem]="duplicateSectionItem.bind(this)"
                        ></section-items>
                    </div>
                    } @empty {
                    <div class="flex flex-col items-center justify-center py-8 text-surface-500">
                        <i class="pi pi-inbox text-4xl mb-3"></i>
                        <div class="font-semibold text-lg mb-1">No se encontraron secciones</div>
                        <div class="text-sm">Intenta ajustar tu búsqueda o crea una nueva sección para comenzar.</div>
                    </div>
                    }
                </div>
                <context-menu-crud [(selected)]="currentSection" [editCommand]="edit" [deleteCommand]="delete" [duplicateCommand]="duplicate"></context-menu-crud>

                <section-item-form [mode]="SectionMode.LAYOUT" [display]="displayItemDialog()" (onCloseDialog)="displayItemDialog.set(false)" [(selectedSectionItem)]="selectedSectionItem" [selectedSection]="currentSection()"></section-item-form>
            </ng-template>
        </app-error-boundary>

        <section-form [mode]="SectionMode.LAYOUT" [display]="display()" (onCloseDialog)="display.set(false)" [selectedPageId]="null" [(selectedSection)]="selectedSection"></section-form>
    </div>
</div>
