<p-confirmdialog />
<div class="flex flex-col max-w-7xl mx-auto">
    <div class="card">
        <div class="flex justify-between items-center flex-wrap gap-4 mb-4 sticky top-16 bg-[var(--surface-card)] pb-2 z-20">
            <div class="flex flex-col gap-0">
                <h5 class="!text-2xl md:!text-4xl !font-extrabold !m-0">Secciones Personalizadas</h5>
                <span class="text-muted-color md:text-xl">Gestiona las secciones personalizadas y sus items</span>
            </div>

            <div class="flex items-center- flex-wrap gap-2">
                <app-error-boundary [resource]="pagesListRs" errorMessage="No se pudieron cargar las páginas." emptyMessage="No hay páginas disponibles.">
                    <ng-template #content let-pages>
                        <p-select
                            [checkmark]="true"
                            [(ngModel)]="selectedPage"
                            placeholder="Selecciona una página"
                            emptyFilterMessage="No se encontraron páginas"
                            [filter]="true"
                            filterPlaceholder="Buscar páginas"
                            [options]="pages"
                            emptyMessage="No se encontraron páginas"
                            optionLabel="title"
                            class="w-full md:w-auto"
                        ></p-select>
                    </ng-template>
                </app-error-boundary>

                <p-button label="Nueva Sección" icon="pi pi-plus" (click)="display.set(true)" [disabled]="!selectedPage()"></p-button>
            </div>
        </div>

        <!-- <sections-list [type]="SectionMode.CUSTOM" [selectedPage]="selectedPage()" (onDisplay)="display.set($event)" (onSelectedSection)="selectedSection.set($event)">
            <ng-template #associatedPage let-section>
                <p-button label="Mover a" icon="pi pi-file" [disabled]="sectionService.loading()" class="ml-auto" variant="outlined" (click)="op.toggle($event)"> </p-button>
                <p-popover #op>
                    <div class="flex flex-col gap-4 w-xs">
                        <app-error-boundary [resource]="pagesListRs" emptyMessage="No hay páginas disponibles para mover" errorMessage="Hubo un error al cargar las páginas">
                            <p-select
                                #pageSelect
                                size="small"
                                [loading]="sectionService.loading()"
                                emptyMessage="No hay páginas disponibles para mover"
                                emptyFilterMessage="No se encontraron páginas"
                                [options]="pages()"
                                (onChange)="moveToPage($event, section, $event.value); op.hide()"
                                (onHide)="pageSelect.updateModel(null); pageSelect.value = null"
                                optionLabel="title"
                                optionValue="id"
                                placeholder="Selecciona la página destino"
                                [filter]="true"
                                filterPlaceholder="Buscar páginas"
                                display="chip"
                                fluid
                            >
                            </p-select>
                        </app-error-boundary>
                    </div>
                </p-popover>
            </ng-template>
        </sections-list> -->
        <!-- {{pageService.pageByIdRs.value() | json}} -->
        <app-error-boundary [resource]="pageService.pageByIdRs" [errorMessage]="'No se pudieron cargar las secciones.'" [emptyMessage]="'No hay secciones disponibles.'">
            <ng-template #loading>
                <app-data-view-skeleton></app-data-view-skeleton>
            </ng-template>

            <ng-template #content let-page>
                @let sections = page?.sections || [];
                <!-- @let filteredSections = sections | filterByPage: { idPage: selectedPage()?.id, type: type() } : ['idPage', 'type'] | filterByTerm :'title': searchTerm() | filterArrayBy: 'type': filterByType(); -->
                <div class="mt-4 flex flex-col gap-4">
                    @if (sections.length === 0) {
                    <div class="flex flex-col items-center justify-center py-8 text-surface-500">
                        <i class="pi pi-inbox text-4xl mb-3"></i>
                        <div class="font-semibold text-lg mb-1">No se encontraron secciones</div>
                        <div class="text-sm">Intenta ajustar tu búsqueda o crea una nueva sección para comenzar.</div>
                    </div>

                    } @else { @if (hasPositionChanged()) {
                    <div class="sticky top-35 bg-[var(--surface-card)] !z-50 mb-4">
                        <p-message (onClose)="cancelChanges()" severity="info" styleClass="w-full" [closable]="true">
                            <ng-template #icon>
                                <p-button (click)="savePositionChanges()" label="Guardar cambios" text class="ml-2" icon="pi pi-save" severity="info"></p-button>
                            </ng-template>
                            <div class="flex items-center justify-between">
                                <span class="ml-2">Has cambiado el orden de las secciones</span>
                            </div>
                        </p-message>
                    </div>
                    } @if (selectedPage()) {

                    <div cdkDropList [cdkDropListData]="sections" (cdkDropListDropped)="drop($event, sections)" class="flex flex-col gap-4">
                        @for (section of sections; track section.id) { @let status = getSectionStatus(section); @let typeOption = getSectionType(section);
                        <div class="bg-white dark:bg-surface-800 rounded-lg border border-surface-200 dark:border-surface-700 p-5" cdkDrag (contextmenu)="contextMenu.onContextMenu($event, section)">
                            <div class="flex items-center justify-between mb-5 flex-wrap gap-3">
                                <div class="flex items-center gap-3">
                                    <!-- Drag handle -->

                                    <i class="pi pi-bars text-surface-600 dark:text-surface-400 cursor-move" aria-label="Drag Handle" cdkDragHandle></i>

                                    <div class="flex flex-col">
                                        <h6 class="!text-xl !m-0 max-w-3xl">{{ section.title }}</h6>
                                        <div class="flex items-center gap-2 flex-wrap">
                                            <p-badge [value]="typeOption.label" [severity]="typeOption.severity" class="text-sm mb-1 w-fit"></p-badge>
                                            <span class="text-muted-color text-sm">{{ section.items.length }} item{{ section.items.length === 1 ? '' : 's' }} • </span>
                                        </div>
                                    </div>
                                </div>

                                <div class="flex flex-col items-center gap-5 flex-wrap ml-auto">
                                    @if (isSectionLayout(section)) {
                                    <p-tag severity="info" class="text-sm ml-auto" value="Sección reutilizable"></p-tag>
                                    }
                                    <div class="flex items-center gap-2 flex-wrap ml-auto">
                                        <p-tag [severity]="status.severity" class="text-sm" [value]="status.label"></p-tag>
                                        @if (![SectionType.MAIN_NAVIGATION_MENU, SectionType.CTA_BANNER, SectionType.MACHINE, SectionType.MACHINE_DETAILS, SectionType.MACHINES_CATALOG, SectionType.FOOTER,
                                        SectionType.PREVENTIVE_CORRECTIVE_MAINTENANCE].includes(section.type)) {
                                        <p-button icon="pi pi-plus" label="Agregar item" (click)="openDialogItem(section)"></p-button>
                                        }

                                        <!-- @if (associatedPageTemplate) {

                                <ng-container *ngTemplateOutlet="associatedPageTemplate; context: { $implicit: section }"></ng-container>
                                } -->

                                        <p-button label="Mover a" icon="pi pi-file" [disabled]="sectionService.loading()" class="ml-auto" variant="outlined" (click)="op.toggle($event)"> </p-button>
                                        <p-popover #op>
                                            <div class="flex flex-col gap-4 w-xs">
                                                <app-error-boundary [resource]="pagesListRs" emptyMessage="No hay páginas disponibles para mover" errorMessage="Hubo un error al cargar las páginas">
                                                    <p-select
                                                        #pageSelect
                                                        size="small"
                                                        [loading]="sectionService.loading()"
                                                        emptyMessage="No hay páginas disponibles para mover"
                                                        emptyFilterMessage="No se encontraron páginas"
                                                        [options]="pages()"
                                                        (onChange)="moveToPage($event, section, $event.value); op.hide()"
                                                        (onHide)="pageSelect.updateModel(null); pageSelect.value = null"
                                                        optionLabel="title"
                                                        optionValue="id"
                                                        placeholder="Selecciona la página destino"
                                                        [filter]="true"
                                                        filterPlaceholder="Buscar páginas"
                                                        display="chip"
                                                        fluid
                                                    >
                                                    </p-select>
                                                </app-error-boundary>
                                            </div>
                                        </p-popover>
                                    </div>
                                </div>
                            </div>

                            <section-items
                                [section]="section"
                                (onSelectSectionItem)="openDialogItem(section, $event)"
                                [deleteItemConfirmation]="deleteSectionItemConfirmation.bind(this)"
                                [duplicateSectionItem]="duplicateSectionItem.bind(this)"
                            ></section-items>
                        </div>
                        }
                    </div>

                    } @else {
                    <div class="alert alert-info" style="text-align: center; margin-top: 2rem">
                        <h2>Seleccione una página</h2>
                        <p>Por favor, elija una página de la lista para ver su contenido.</p>
                    </div>
                    } }

                    <context-menu-crud [(selected)]="currentSection" [editCommand]="edit" [deleteCommand]="delete" [duplicateCommand]="duplicate"></context-menu-crud>
                </div>

                <section-item-form [display]="displayItemDialog()" (onCloseDialog)="displayItemDialog.set(false)" [(selectedSectionItem)]="selectedSectionItem" [selectedSection]="currentSection()"></section-item-form>
            </ng-template>
        </app-error-boundary>

        <section-form [mode]="SectionMode.CUSTOM" [display]="display()" (onCloseDialog)="display.set(false)" [selectedPageId]="selectedPage()?.id!" [(selectedSection)]="selectedSection"></section-form>
    </div>
</div>
