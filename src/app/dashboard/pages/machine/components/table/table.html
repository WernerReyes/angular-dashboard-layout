<app-error-boundary [resource]="categoriesList" emptyMessage="No hay máquinas disponibles." errorMessage="Hubo un error al cargar las máquinas.">
    <ng-template #loading>
        <app-data-view-skeleton></app-data-view-skeleton>
    </ng-template>

    <ng-template #content let-categories>
        <p-confirm-dialog />
        <p-contextmenu #cm [model]="items" (onHide)="selectedCategory.set(null)" />
        <p-table [value]="categories" [(contextMenuSelection)]="selectedCategory" [contextMenu]="cm" sortField="title" sortMode="single" dataKey="id" rowGroupMode="subheader" groupRowsBy="id" [tableStyle]="{'min-width': '70rem'}">
            <ng-template #header>
                <tr>
                    <th style="width: 10%">Nombre</th>
                    <th style="width: 20%">Breve Descripción</th>
                    <th style="width: 30%">Descripción completa</th>
                    <th style="width: 20%">Imagenes</th>
                    <th style="width: 10%">Especificaciones Técnicas</th>
                    <th style="width: 20%">Creación</th>
                    <th style="width: 20%">Última Modificación</th>
                </tr>
            </ng-template>
            <ng-template #groupheader let-category let-rowIndex="rowIndex" let-expanded="expanded">
                <tr [pContextMenuRow]="category">
                    <td colspan="7" class="w-full">
                        <button type="button" pButton pRipple [pRowToggler]="category" text rounded plain class="mr-2" [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></button>
                        @let type = getType(category.type);

                        <span class="font-bold ml-2">{{category.title}}</span>

                        <p-tag class="ml-4" [value]="type.label" [severity]="type.severity" [icon]="type.icon"></p-tag>
                    </td>
                </tr>
            </ng-template>
            <ng-template #groupfooter let-category>
                <tr class="p-rowgroup-footer">
                    <td colspan="6" style="text-align: right">Total de máquinas</td>
                    <!-- <td>{{calculateCustomerTotal(customer.representative.name)}}</td> -->
                    <td>{{category.machines.length}}</td>
                </tr>
            </ng-template>
            <ng-template #expandedrow let-category>
                @let machines = category.machines; @if (machines.length === 0) {
                <tr>
                    <td colspan="7" class="text-center">No hay máquinas en esta categoría.</td>
                </tr>
                } @else { @for (machine of machines; track machine.id) {

                <tr>
                    <td>{{machine.name}}</td>
                    <td>{{machine.description}}</td>
                    <td>
                        <div class="line-clamp-3">{{machine.longDescription}}</div>
                    </td>
                    <td>
                        @if (machine.images && machine.images.length > 0) {

                        <div class="flex flex-wrap gap-2">
                            @for (img of machine.images; track img.id) {
                            <!-- <img [src]="img" alt="Machine Image" class="w-16 h-16 object-cover rounded" /> -->
                            <p-image [src]="img" [preview]="true" alt="Image" class="size-28 object-cover"  >
                                <ng-template #indicator>
                                    <i class="pi pi-search"></i>
                                </ng-template>
                                <ng-template #image>
                                    <img [src]="img" alt="image" width="250" />
                                </ng-template>
                                <ng-template #preview let-style="style" let-previewCallback="previewCallback">
                                    <img src="https://primefaces.org/cdn/primeng/images/galleria/galleria11.jpg" alt="image"   />
                                </ng-template>
                            </p-image>

                            }
                            <!-- <img *ngFor="let img of machine.images" [src]="img.url" alt="Machine Image" class="w-16 h-16 object-cover rounded" /> -->
                        </div>
                        } @else {

                        <span>No hay imágenes</span>
                        }
                    </td>
                    <td>
                        <p-button type="button" label="Ver" icon="pi pi-eye" text (click)="displaySpecifications($event, machine)"></p-button>
                    </td>
                    <td>{{ machine.createdAt | date: 'short' }}</td>
                    <td>{{ machine.updatedAt | date: 'short' }}</td>
                </tr>
                } }
            </ng-template>
            <p-popover #op (onHide)="selectedMachine.set(null)">
                <technical-specifications-table [specifications]="selectedMachine()?.technicalSpecifications ?? []"></technical-specifications-table>
            </p-popover>
        </p-table>

        <machine-dialog-form [(display)]="dialogMachine"></machine-dialog-form>
    </ng-template>
</app-error-boundary>
