<!-- <p-confirmdialog key="positionDialog" [position]="'bottom'" /> -->

<app-error-boundary [resource]="menuList" errorMessage="Ocurrió un error cargando los menús." emptyMessage="No hay menús">
    <ng-template #loading>
        <app-data-view-skeleton></app-data-view-skeleton>
    </ng-template>

    <p-inputgroup>
        <p-inputgroup-addon>
            <i class="pi pi-search cursor-pointer"></i>
        </p-inputgroup-addon>
        <input pInputText placeholder="Buscar menu..." [(ngModel)]="searchQuery" />
    </p-inputgroup>
    <p-divider></p-divider>

    @if (filteredMenuList().length === 0) {
    <div class="flex flex-col items-center justify-center py-8 text-surface-500">
        <i class="pi pi-inbox text-4xl mb-3"></i>
        <div class="font-semibold text-lg mb-1">No se encontraron menús</div>
        <div class="text-sm">Intenta ajustar tu búsqueda o crea un nuevo menú para comenzar.</div>
    </div>
    } @else { 
        
        @if (hasPositionChanged()) {
    <p-message (onClose)="cancelChanges()" severity="info" class="w-full" [closable]="true">
        <ng-template #icon>
            <p-button (click)="savePositionChanges()" label="Guardar cambios" text class="ml-2" icon="pi pi-save" severity="info"></p-button>
        </ng-template>
        <div class="flex items-center justify-between">
            <span class="ml-2">Has cambiado el orden de las secciones</span>
            <div></div>
        </div>
    </p-message>

    }
    <div class="space-y-4"
    
      [class]="{
        'mt-5': hasPositionChanged()
      }"
    cdkDropList [cdkDropListData]="filteredMenuList()" (cdkDropListDropped)="drop($event, filteredMenuList())">
        @for (menuItem of filteredMenuList(); track menuItem.id) { @let link = menuItem.link; @let activeStatus = menuActiveStatus[`${menuItem.active}`];
        <div class="bg-white dark:bg-surface-800 rounded-lg border border-surface-200 dark:border-surface-700" cdkDrag>
            <!-- Item principal -->
            <div class="p-4">
                <div class="flex items-center justify-between flex-wrap gap-4">
                    <div class="flex items-center space-x-3">
                        <!-- Drag handle -->
                        <i class="pi pi-bars text-surface-600 dark:text-surface-400 cursor-move" aria-label="Drag Handle" cdkDragHandle></i>

                        <!-- Chevron para submenu -->
                        @if (menuItem.children && menuItem.children.length > 0) {
                        <button class="p-1" (click)="menuItem.expanded = !menuItem.expanded" aria-label="Toggle Submenu">
                            <i [class]="menuItem.expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'" class="text-surface-600 dark:text-surface-400"></i>
                        </button>
                        }

                        <div>
                            <div class="font-medium text-surface-900 dark:text-surface-0">{{ menuItem.title }}</div>

                            @if (menuItem.children?.length === 0) {
                            <div class="bg-surface-100 truncate text-ellipsis max-w-72 xl:max-w-full px-3 w-fit" style="border-radius: 30px">
                                <i
                                    class="pi pi-file !text-[12px] text-secondary dark:text-black mr-2"
                                    [class]="{
                                                'pi-file': link?.type === LinkType.PAGE,
                                                'pi-external-link': link?.type === LinkType.EXTERNAL
                                            }"
                                ></i>
                                <span class="text-secondary dark:text-black font-medium text-sm">{{ link?.title }}</span>
                            </div>
                            }
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <p-tag [value]="activeStatus.label" [severity]="activeStatus.severity" class="text-sm" />
                        <p-button icon="pi pi-pencil" text aria-label="Edit Menu Item" (click)="openDialogAndEdit(menuItem)"></p-button>
                        <p-button icon="pi pi-trash" text severity="danger" aria-label="Delete Menu Item"></p-button>
                    </div>
                </div>
            </div>

            <!-- Submenu items -->
            @if (menuItem.children && menuItem.children.length > 0 && menuItem.expanded) {
            <div cdkDropList [cdkDropListData]="menuItem.children" (cdkDropListDropped)="drop($event, menuItem.children)">
                @for (child of menuItem.children; track child.id) { @let link = child.link; @let activeStatus = menuActiveStatus[`${child.active}`];
                <div class="border-t border-surface-200 dark:border-surface-700 bg-surface-50 dark:bg-surface-900 p-4" cdkDrag>
                    <div class="flex items-center justify-between ml-9 flex-wrap gap-4">
                        <div class="flex items-center space-x-3">
                            <i class="pi pi-bars text-surface-600 dark:text-surface-400 cursor-move" aria-label="Drag Handle" cdkDragHandle></i>
                            <div>
                                <div class="font-medium text-surface-900 dark:text-surface-0">{{ child.title }}</div>

                                <div class="bg-surface-100 truncate text-ellipsis max-w-72 xl:max-w-full px-3 w-fit" style="border-radius: 30px">
                                    <i
                                        class="pi pi-file !text-[12px] text-secondary dark:text-black mr-2"
                                        [class]="{
                                            'pi-file': link?.type === LinkType.PAGE,
                                            'pi-external-link': link?.type === LinkType.EXTERNAL
                                        }"
                                    ></i>
                                    <span class="text-secondary dark:text-black font-medium text-sm">{{ link?.title }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <p-tag [value]="activeStatus.label" [severity]="activeStatus.severity" class="text-sm" />
                            <p-button icon="pi pi-pencil" text aria-label="Edit Menu Item" (click)="openDialogAndEdit(child)"></p-button>
                            <p-button icon="pi pi-trash" text severity="danger" aria-label="Delete Menu Item"></p-button>
                        </div>
                    </div>
                </div>
                }
            </div>
            }
        </div>
        }
    </div>
    }
</app-error-boundary>
